<%- include('../../../partials/header') %>

<h2 class="display-6 text-center">Guest Record</h2>

<!-- display any flash messages -->
<div class="w-50 mx-auto text-center mt-3">
    <%- include('../../../partials/flash') %>
</div>

<%- include('../../../partials/guest-card') %>

<div class="container">

    <h4 class="display-9 ">Visit History</h4>
    <!-- record visit history display -->
    <div class="table-responsive my-3" style="max-height: 600px">
        <table class="table table-striped table-hover">
        <thead>
            <tr>
            
            <th scope="col" style="text-align: center;">#</th>
            <th scope="col" style="text-align: center;">Check-in</th>
            <th scope="col" style="text-align: center;">Check-out</th>
            <th scope="col" style="text-align: center;">Duration</th>
            <th scope="col" style="text-align: center;">Kennel</th>
            <th scope="col" style="text-align: center;">Services</th>
            <th scope="col" style="text-align: center;">Cost</th>
            <th scope="col" style="text-align: center;"></th>
        
            </tr>
        </thead>
        <tbody>
            <!-- sorted by most recent visit -->
            <% const sortedVisitsArr = [...guest.visits].sort((b, a) => a.endDate - b.endDate)%>
            <% for(let visit of sortedVisitsArr) { %>
                <tr>
                <td valign="middle" style="text-align: center;"> <%= visit.number %></a></td>
                <td valign="middle" style="text-align: center;"> <%= visit.formatDate('startDate') %></td>
                <td valign="middle" style="text-align: center;"> <%= visit.formatDate('endDate') %></td>
                <td valign="middle" style="text-align: center;">
                    <%= visit.duration %> <% if (visit.duration > 1) { %>
                        days
                        <% } else { %>
                        day <% } %>
                    </td>
                <td valign="middle" style="text-align: center;"><%= visit.assignedKennel.formatted_id %></td>
                <td valign="middle" style="text-align: center;">
                    <!-- formatting style to indicate rendered status -->
                    <% for (i = 0; i < visit.services.length; i++) { %>
                        <% var appendStr = '' %>

                        <!-- if service not present in servicesRendered arr... -->
                        <% const test = (element) => element.name === visit.services[i].name  %>
                        
                        <span <% if (!visit.servicesRendered.some(test)) { %>
                            style='color: crimson'
                            <% } %>
                            >

                        <%if (visit.services.length > i + 1) { _%>
                            <% appendStr = ',' %>
                        <% } %>

                        <%= visit.services[i].name %></span><%= appendStr %>
        
                    <% } %>

                </td>
                <% const paidStr = visit.paid? 'Paid' : 'Unpaid' %>

                <!-- tallying total cost of visit  -->
                <% var totalCost = visit.baseCost %>
                <% for (i = 0; i < visit.services.length; i++) { %>
                    <% totalCost += visit.services[i].price  %>
                <% } %>
                
                <td valign="middle" style="text-align: center;"> $<%= totalCost %> <span <% if (!visit.paid) { %>
                    style='color: crimson'
                <% } else { %>
                    style='color: green'
                <% } %>>(<%= paidStr %>)</span></td>
                <td  style="text-align: center;"> <a href="/visit-records/<%=visit._id%>" class="btn btn-outline-primary btn-sm">Details</a> </td>
    
                </tr>
            <% } %>
        </tbody>
        </table>

        <% if ([...guest.visits].length === 0) { %>
            <div class="text-center my-3"><i>No visit history to display.</i></div>
            <% } %>
    </div>

    <!-- visit add, edit and delete buttons -->
    <div class="mx-auto text-center">
            <a href="/visit-records/new/<%=guest._id %>" type="button" class="btn btn-primary">Add new visit</a> 
    </div>

    <!-- back (return to index) button -->
    <div class="mx-auto mt-3">
        <a href="/guest-records/" class="btn btn-outline-primary"><- All Guests</a>
    </div>


</div> <!--end of container -->



</div>
<%- include('../../../partials/footer') %>